<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ljr_test2</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
        }
        
        canvas {
            display: block;
        }
        
        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            pointer-events: none;
        }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .controls {
            position: fixed;
            right: 12px;
            bottom: 12px;
            background: rgba(20, 20, 20, 0.6);
            color: #fff;
            padding: 10px 12px;
            border-radius: 10px;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            backdrop-filter: blur(6px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.35);
            user-select: none;
        }
        .controls label {
            display: block;
            font-size: 12px;
            margin: 6px 0 2px;
        }
        .controls input[type="range"] {
            width: 180px;
        }
        .controls .row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
        }
        .btn {
            background: #ff6b6b;
            border: none;
            color: #fff;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
        }
        .btn.secondary {
            background: #4dabf7;
        }
        .btn.small { padding: 4px 8px; font-size: 12px; }
        .status { font-size: 12px; opacity: 0.85; margin-top: 6px; }
        .row input[type="file"] { max-width: 160px; }
        .energy { height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; overflow: hidden; width: 180px; }
        .energy > span { display: block; height: 100%; width: 0%; background: linear-gradient(90deg,#4dabf7,#ff6b6b); }
        /* æ‰“èµå¼¹çª—æ ·å¼ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1002; }
        .modal.show { display: flex; }
        .modal-box { background: #111; color: #fff; border-radius: 12px; padding: 14px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); max-width: 80vw; }
        .modal-box h3 { margin: 0 0 8px; font-weight: 600; }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 10px; }
        .modal-box img { display: block; max-width: 70vw; max-height: 70vh; border-radius: 8px; }
        .fallback { font-size: 12px; opacity: 0.85; display: none; }

        /* æ‚¬æµ®æ‰“èµæŒ‰é’®ï¼ˆæ›´æ˜æ˜¾ï¼‰ */
        .floating-donate {
            position: fixed;
            right: 14px;
            bottom: 110px;
            z-index: 1000;
            background: linear-gradient(90deg,#ff6b6b,#ffa94d);
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 10px 14px;
            font-weight: 600;
            box-shadow: 0 6px 20px rgba(0,0,0,0.35);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform .15s ease, box-shadow .2s ease;
            animation: pulse 2.6s infinite;
        }
        .floating-donate:hover { transform: translateY(-2px); box-shadow: 0 10px 24px rgba(0,0,0,0.45); }
        @keyframes pulse { 0%{transform: scale(1)} 50%{transform: scale(1.05)} 100%{transform: scale(1)} }

        /* é›…æ€å£è¯­é™ªç»ƒå…¥å£ä¸å¼¹çª— */
        .floating-coach {
            position: fixed; right: 14px; bottom: 170px; z-index: 1000;
            background: linear-gradient(90deg,#4dabf7,#845ef7);
            color: #fff; border: none; border-radius: 999px;
            padding: 14px 18px; font-weight: 700; font-size: 16px;
            box-shadow: 0 10px 26px rgba(132,94,247,0.45);
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: transform .15s ease, box-shadow .2s ease;
            animation: pulse 2.2s infinite;
        }
        .floating-coach:hover { transform: translateY(-2px); box-shadow: 0 14px 32px rgba(132,94,247,0.55); }
        .floating-coach::after { content: ""; position: absolute; inset: -6px; border-radius: 999px; box-shadow: 0 0 0 3px rgba(132,94,247,0.45); animation: ring 1.8s ease-out infinite; pointer-events: none; }
        @keyframes ring { 0%{opacity:.8; transform:scale(1)} 100%{opacity:0; transform:scale(1.25)} }
        .coach-modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index: 999; }
        .coach-modal.show { display:flex; }
        .coach-box { background:#111; color:#fff; border-radius:12px; padding:14px; box-shadow:0 8px 32px rgba(0,0,0,0.5); width:min(860px,90vw); }
        .coach-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .coach-controls { display:flex; gap:8px; flex-wrap: wrap; margin:8px 0; }
        .coach-log { background:#0c0c0c; border-radius:8px; padding:10px; max-height:45vh; overflow:auto; font-size:14px; line-height:1.5; }
        .coach-log p { margin:6px 0; }
        .coach-footer { display:flex; gap:8px; margin-top:10px; justify-content:flex-end; }
        .tag { padding:2px 8px; border-radius:999px; background:#1b1b1b; font-size:12px; }
        .pron-panel { display:flex; gap:10px; flex-wrap:wrap; margin:8px 0; }
        .pron-item { background:#1b1b1b; border-radius:8px; padding:8px 10px; font-size:12px; }
    </style>
</head>
<body>
    <canvas id="fireworksCanvas"></canvas>
    <button id="floatingDonate" class="floating-donate" aria-label="æ‰“èµæ”¯æŒ">ğŸ’š æ‰“èµæ”¯æŒ</button>
    <button id="floatingCoach" class="floating-coach" aria-label="é›…æ€å£è¯­é™ªç»ƒ">ğŸ—£ï¸ é›…æ€é™ªç»ƒ</button>
    <div class="controls">
        <div class="row">
            <button id="toggleBtn" class="btn">æš‚åœ</button>
            <button id="burstBtn" class="btn secondary">ä¸€é”®çƒŸèŠ±</button>
            <button id="donateBtn" class="btn small">æ‰“èµ</button>
        </div>
        <div class="row">
            <label><input id="aiMode" type="checkbox"> AIæ¨¡å¼</label>
            <button id="likeBtn" class="btn small secondary">å–œæ¬¢ğŸ‘</button>
            <button id="dislikeBtn" class="btn small">ä¸å–œæ¬¢ğŸ‘</button>
        </div>
        <div class="row">
            <label><input id="musicSync" type="checkbox"> éŸ³ä¹åŒæ­¥</label>
            <input id="audioFile" type="file" accept="audio/*">
            <button id="playMusicBtn" class="btn small secondary">æ’­æ”¾</button>
            <button id="pauseMusicBtn" class="btn small">æš‚åœ</button>
        </div>
        <label>å¯†åº¦ï¼ˆæ¯å¸§å‘å°„æ¦‚ç‡ï¼‰</label>
        <input id="density" type="range" min="0" max="0.15" step="0.005" value="0.03">
        <label>é‡åŠ›ï¼ˆç²’å­ä¸‹è½åŠ é€Ÿåº¦ï¼‰</label>
        <input id="gravity" type="range" min="0" max="0.25" step="0.005" value="0.05">
        <div class="row"><label><input id="trail" type="checkbox" checked> å°¾è¿¹</label></div>
        <div id="aiStatus" class="status"></div>
        <div id="musicStatus" class="status"></div>
        <div class="energy"><span id="energyBar"></span></div>
    </div>

    <!-- æ‰“èµå¼¹çª— -->
    <div id="donateModal" class="modal" aria-hidden="true">
        <div class="modal-box" role="dialog" aria-modal="true">
            <h3>æ‰“èµæ”¯æŒ</h3>
            <p class="fallback" id="donateFallback">è¯·å°†ä½ çš„æ”¶æ¬¾ç å›¾ç‰‡ä¿å­˜ä¸º <code>donate.png</code> æˆ– <code>donate.jpg</code> åˆ°ç«™ç‚¹æ ¹ç›®å½•ï¼ˆä¸æœ¬é¡µé¢åŒçº§ï¼‰ï¼Œæ‰“å¼€æ­¤å¼¹çª—å³å¯æ˜¾ç¤ºã€‚</p>
            <img id="donateImg" src="donate.png" alt="æ‰“èµäºŒç»´ç ">
            <div class="modal-actions">
                <a id="donateDownload" class="btn small secondary" href="donate.png" download>ä¿å­˜å›¾ç‰‡</a>
                <button id="closeDonate" class="btn small">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- é›…æ€å£è¯­é™ªç»ƒå¼¹çª— -->
    <div id="coachModal" class="coach-modal" aria-hidden="true">
        <div class="coach-box" role="dialog" aria-modal="true">
            <div class="coach-header">
                <h3 style="margin:0">é›…æ€å£è¯­é™ªç»ƒ</h3>
                <span class="tag">Beta</span>
            </div>
            <div class="coach-controls">
                <select id="coachPart">
                    <option value="1">Part 1 æ—¥å¸¸é—®ç­”</option>
                    <option value="2">Part 2 é•¿æ®µé™ˆè¿°</option>
                    <option value="3">Part 3 æ·±åº¦è®¨è®º</option>
                </select>
                <select id="coachTopic">
                    <option value="hometown">å®¶ä¹¡</option>
                    <option value="work">å·¥ä½œ/å­¦ä¹ </option>
                    <option value="travel">æ—…è¡Œ</option>
                    <option value="technology">ç§‘æŠ€</option>
                    <option value="environment">ç¯å¢ƒ</option>
                </select>
                <button id="coachStart" class="btn small secondary">å¼€å§‹</button>
                <button id="coachStop" class="btn small">ç»“æŸ</button>
                <button id="coachExport" class="btn small">å¯¼å‡ºè®°å½•</button>
                <label style="display:flex;align-items:center;gap:6px"><input id="aiCoachEnable" type="checkbox"> æ¥å…¥AI</label>
                <input id="aiModelInput" type="text" placeholder="æ¨¡å‹ï¼Œå¦‚ gpt-4o-mini" style="width:160px">
                <input id="aiApiBase" type="text" placeholder="API åŸºå€ï¼Œå¦‚ https://api.openai.com/v1" style="width:220px">
                <input id="aiApiKey" type="password" placeholder="API Key" style="width:220px">
                <button id="aiSaveBtn" class="btn small secondary">ä¿å­˜AIé…ç½®</button>
                <select id="aiLang">
                    <option value="zh">ä¸­æ–‡åé¦ˆ</option>
                    <option value="en">è‹±æ–‡åé¦ˆ</option>
                </select>
            </div>
            <div id="coachStatus" class="status"></div>
            <div class="pron-panel">
                <label style="display:flex;align-items:center;gap:6px"><input id="pronEnable" type="checkbox" checked> å‘éŸ³åˆ†æ</label>
                <div class="pron-item">éŸ³é‡ <span id="pronVol">-</span></div>
                <div class="pron-item">éŸ³é«˜ <span id="pronPitch">-</span></div>
                <div class="pron-item">è¯­é€Ÿ <span id="pronRate">-</span></div>
                <div class="pron-item">åœé¡¿ <span id="pronPauses">-</span></div>
            </div>
            <div id="coachLog" class="coach-log" aria-live="polite"></div>
            <div class="coach-footer">
                <input id="coachText" type="text" placeholder="æ²¡æœ‰éº¦å…‹é£æ—¶åœ¨æ­¤è¾“å…¥å›ç­”" style="flex:1; padding:8px; border-radius:6px; border:none; background:#1b1b1b; color:#fff;">
                <button id="coachSend" class="btn small secondary">å‘é€</button>
                <button id="closeCoach" class="btn small">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('fireworksCanvas');
            const ctx = canvas.getContext('2d');
            const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
            const dpr = Math.min(isMobile ? 1.6 : 2, Math.max(1, window.devicePixelRatio || 1));
            // æ˜Ÿç©ºæ•°ç»„éœ€åœ¨ resize() è°ƒç”¨å‰å£°æ˜
            let stars = [];

            // è®¾ç½®é«˜ DPI ç”»å¸ƒå¤§å°
            function resize() {
                canvas.style.width = window.innerWidth + 'px';
                canvas.style.height = window.innerHeight + 'px';
                canvas.width = Math.floor(window.innerWidth * dpr);
                canvas.height = Math.floor(window.innerHeight * dpr);
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                initStars();
            }
            resize();
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', resize);
            
            // æ˜Ÿç©ºèƒŒæ™¯
            function initStars() {
                const count = Math.floor((window.innerWidth * window.innerHeight) / 12000); // è‡ªé€‚åº”æ•°é‡
                stars = new Array(count).fill(0).map(() => ({
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight,
                    r: Math.random() * 1.6 + 0.4,
                    baseAlpha: Math.random() * 0.6 + 0.2,
                    phase: Math.random() * Math.PI * 2,
                    twinkle: Math.random() * 0.8 + 0.2,
                    drift: (Math.random() - 0.5) * 0.02
                }));
            }
            function drawStars() {
                // æ¸å˜å¤œç©º
                const g = ctx.createLinearGradient(0, 0, 0, window.innerHeight);
                g.addColorStop(0, '#0b1023');
                g.addColorStop(1, '#000000');
                ctx.fillStyle = g;
                ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);

                // æ˜Ÿç‚¹
                for (const s of stars) {
                    s.phase += 0.02;
                    s.x += s.drift;
                    if (s.x < 0) s.x = window.innerWidth;
                    if (s.x > window.innerWidth) s.x = 0;
                    const a = s.baseAlpha * (0.6 + 0.4 * Math.sin(s.phase * s.twinkle));
                    ctx.save();
                    ctx.globalAlpha = a;
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                    ctx.fillStyle = '#cfe8ff';
                    ctx.fill();
                    ctx.restore();
                }
            }

            // çƒŸèŠ±ç²’å­ç±»
            class Particle {
                constructor(x, y, color, gravity) {
                    this.x = x;
                    this.y = y;
                    this.color = color;
                    this.radius = Math.random() * 2 + 1;
                    this.velocity = {
                        x: (Math.random() - 0.5) * 10,
                        y: (Math.random() - 0.5) * 10
                    };
                    this.alpha = 1;
                    this.gravity = gravity;
                    this.decay = 0.015;
                    this.trail = [];
                    this.maxTrail = 8;
                }
                
                draw() {
                    ctx.save();
                    ctx.globalAlpha = this.alpha;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                    // ç”»å°¾è¿¹
                    if (trailEnabled && this.trail.length > 1) {
                        ctx.globalAlpha = Math.max(0.05, this.alpha * 0.3);
                        ctx.strokeStyle = this.color;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(this.trail[0].x, this.trail[0].y);
                        for (let i = 1; i < this.trail.length; i++) {
                            ctx.lineTo(this.trail[i].x, this.trail[i].y);
                        }
                        ctx.stroke();
                    }
                    ctx.restore();
                }
                
                update() {
                    this.velocity.y += this.gravity;
                    this.x += this.velocity.x;
                    this.y += this.velocity.y;
                    this.alpha -= this.decay;
                    // æ›´æ–°å°¾è¿¹
                    this.trail.push({ x: this.x, y: this.y });
                    if (this.trail.length > this.maxTrail) this.trail.shift();
                    
                    this.draw();
                    return this.alpha > 0;
                }
            }
            
            // çƒŸèŠ±å‘å°„å™¨
            class Firework {
                constructor(x = Math.random() * canvas.width / dpr,
                            targetY = Math.random() * (canvas.height / dpr) * 0.5,
                            hue = Math.random() * 360,
                            gravity = 0.05,
                            particleCount = null) {
                    this.particles = [];
                    this.color = `hsl(${hue}, 100%, 60%)`;
                    this.x = x;
                    this.y = canvas.height / dpr;
                    this.targetY = targetY;
                    this.gravity = gravity;
                    this.speed = 5;
                    this.velocity = (Math.random() - 0.5) * 2;
                    this.particleCount = particleCount;
                }
                
                update() {
                    // å‘å°„çƒŸèŠ±åˆ°ç›®æ ‡é«˜åº¦
                    if (this.y > this.targetY) {
                        this.y -= this.speed;
                        this.x += this.velocity;
                        
                        // ç»˜åˆ¶ä¸Šå‡çš„çƒŸèŠ±
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
                        ctx.fillStyle = this.color;
                        ctx.fill();
                        
                        return true;
                    } else {
                        // çˆ†ç‚¸æ•ˆæœ
                        if (this.particles.length === 0) {
                            const count = (this.particleCount != null)
                                ? this.particleCount
                                : 90 + Math.floor(Math.random() * 40);
                            for (let i = 0; i < count; i++) {
                                this.particles.push(new Particle(this.x, this.y, this.color, gravityValue));
                            }
                        }
                        
                        // æ›´æ–°çˆ†ç‚¸ç²’å­
                        for (let i = this.particles.length - 1; i >= 0; i--) {
                            if (!this.particles[i].update()) {
                                this.particles.splice(i, 1);
                            }
                        }
                        
                        return this.particles.length > 0;
                    }
                }
            }
            
            // çƒŸèŠ±æ•°ç»„
            const fireworks = [];
            let running = true;
            let spawnProbability = 0.03;
            let gravityValue = 0.05;
            let trailEnabled = true;
            let aiEnabled = false;
            let particleCountOverride = null;
            let lastArmIndex = null;

            // éŸ³ä¹åŒæ­¥
            let musicEnabled = false;
            let audioCtx = null, analyser = null, sourceNode = null, audioEl = null;
            let musicEnergy = 0; // 0~1
            const energyBar = document.getElementById('energyBar');
            const musicStatusEl = document.getElementById('musicStatus');
            function updateMusicEnergy() {
                if (!musicEnabled || !analyser) return 0;
                const arr = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(arr);
                // ä½é¢‘æ›´è´´è¿‘é¼“ç‚¹ï¼šå–å‰ 64 ä¸ªé¢‘æ®µ
                let sum = 0; const n = Math.min(64, arr.length);
                for (let i = 0; i < n; i++) sum += arr[i] / 255;
                musicEnergy = Math.min(1, sum / n);
                energyBar.style.width = Math.round(musicEnergy * 100) + '%';
                musicStatusEl.textContent = musicEnabled ? `éŸ³ä¹èƒ½é‡ ${musicEnergy.toFixed(2)}` : '';
                return musicEnergy;
            }

            // ç®€æ˜“å¤šè‡‚è€è™æœºï¼šè‹¥ç”¨æˆ·ç‚¹èµåˆ™æå‡ç»„åˆçš„æœŸæœ›å¥–åŠ±
            const arms = [
                { name: 'æŸ”å’Œæ¼‚æµ®', spawn: 0.02, gravity: 0.02, hueMin: 180, hueMax: 260, count: 100 },
                { name: 'çƒ­çƒˆçˆ†è£‚', spawn: 0.06, gravity: 0.06, hueMin: 0,   hueMax: 60,  count: 130 },
                { name: 'æ¸…å†·æ˜Ÿæ²³', spawn: 0.03, gravity: 0.035, hueMin: 260, hueMax: 320, count: 110 },
                { name: 'é‡‘è‰²ç¤¼èŠ±', spawn: 0.03, gravity: 0.045, hueMin: 40,  hueMax: 60,  count: 90 }
            ];
            const stats = arms.map(() => ({ plays: 0, reward: 0 }));
            const aiStatusEl = document.getElementById('aiStatus');

            function chooseArm() {
                const epsilon = 0.2; // æ¢ç´¢æ¦‚ç‡
                if (Math.random() < epsilon) {
                    return Math.floor(Math.random() * arms.length);
                }
                let best = 0; let bestScore = -Infinity;
                for (let i = 0; i < arms.length; i++) {
                    const s = stats[i];
                    const avg = s.plays > 0 ? (s.reward / s.plays) : 0; // ä¹è§‚åˆå§‹åŒ–å¯æ”¹è¿›
                    if (avg > bestScore) { bestScore = avg; best = i; }
                }
                return best;
            }

            function applyArm(i) {
                const arm = arms[i];
                spawnProbability = arm.spawn;
                gravityValue = arm.gravity;
                particleCountOverride = arm.count;
                lastArmIndex = i;
                aiStatusEl.textContent = `AIé€‰æ‹©ï¼š${arm.name} | å¯†åº¦ ${spawnProbability.toFixed(3)} | é‡åŠ› ${gravityValue.toFixed(3)} | ç²’å­ ${arm.count}`;
            }
            
            // åŠ¨ç”»å¾ªç¯
            let lastTime = performance.now();
            let fpsAvg = 60;
            let maxFireworks = isMobile ? 8 : 12;
            function animate() {
                const now = performance.now();
                const dt = Math.max(1, now - lastTime);
                const fps = 1000 / dt;
                fpsAvg = fpsAvg * 0.9 + fps * 0.1;
                lastTime = now;
                // æ˜Ÿç©ºèƒŒæ™¯ä¸æ‹–å½±
                drawStars();
                if (trailEnabled) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.08)';
                    ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
                }

                // æ›´æ–°å’Œç»˜åˆ¶çƒŸèŠ±
                for (let i = fireworks.length - 1; i >= 0; i--) {
                    if (!fireworks[i].update()) {
                        fireworks.splice(i, 1);
                    }
                }

                // éšæœºæ·»åŠ æ–°çƒŸèŠ±ï¼ˆè‡ªé€‚åº”é™è½½ï¼‰
                const energy = updateMusicEnergy();
                const spawnBoost = musicEnabled ? (0.7 + energy * 1.5) : 1;
                let effectiveSpawn = Math.min(0.18, spawnProbability * spawnBoost);
                if (fpsAvg < 50) effectiveSpawn *= 0.75;
                if (fpsAvg < 35) { effectiveSpawn *= 0.5; trailEnabled = false; maxFireworks = isMobile ? 6 : 10; }
                if (running && Math.random() < effectiveSpawn && fireworks.length < maxFireworks - 2) {
                    const hue = aiEnabled && lastArmIndex != null
                        ? (arms[lastArmIndex].hueMin + Math.random() * (arms[lastArmIndex].hueMax - arms[lastArmIndex].hueMin))
                        : Math.random() * 360;
                    fireworks.push(new Firework(undefined, undefined, hue, gravityValue, particleCountOverride));
                }

                // éŸ³ä¹è„‰å†²ï¼šèƒ½é‡æ˜¾è‘—æ—¶è§¦å‘ç¤¼èŠ±
                if (musicEnabled && energy > 0.65 && fireworks.length < maxFireworks) {
                    for (let i = 0; i < 2; i++) {
                        const hue = aiEnabled && lastArmIndex != null
                            ? (arms[lastArmIndex].hueMin + Math.random() * (arms[lastArmIndex].hueMax - arms[lastArmIndex].hueMin))
                            : Math.random() * 360;
                        fireworks.push(new Firework(Math.random() * (window.innerWidth), undefined, hue, gravityValue, (particleCountOverride || 120)));
                    }
                }

                requestAnimationFrame(animate);
            }
            
            // å¯åŠ¨åŠ¨ç”»
            animate();

            // äº¤äº’ï¼šç‚¹å‡»/è§¦æ‘¸ç”ŸæˆçƒŸèŠ±
            function spawnAt(clientX, clientY) {
                const rect = canvas.getBoundingClientRect();
                const x = (clientX - rect.left);
                const y = (clientY - rect.top);
                const targetY = Math.max(60, y - 120);
                const hue = aiEnabled && lastArmIndex != null
                    ? (arms[lastArmIndex].hueMin + Math.random() * (arms[lastArmIndex].hueMax - arms[lastArmIndex].hueMin))
                    : Math.random() * 360;
                fireworks.push(new Firework(x, targetY, hue, gravityValue, particleCountOverride));
            }
            canvas.addEventListener('click', (e) => { unlockAudio(); spawnAt(e.clientX, e.clientY); });
            canvas.addEventListener('touchstart', (e) => {
                const t = e.touches[0];
                unlockAudio();
                spawnAt(t.clientX, t.clientY);
            }, { passive: true });

            // æ§åˆ¶é¢æ¿é€»è¾‘
            const toggleBtn = document.getElementById('toggleBtn');
            const burstBtn = document.getElementById('burstBtn');
            const density = document.getElementById('density');
            const gravity = document.getElementById('gravity');
            const trail = document.getElementById('trail');
            const aiMode = document.getElementById('aiMode');
            const likeBtn = document.getElementById('likeBtn');
            const dislikeBtn = document.getElementById('dislikeBtn');
            const musicSync = document.getElementById('musicSync');
            const audioFile = document.getElementById('audioFile');
            const playMusicBtn = document.getElementById('playMusicBtn');
            const pauseMusicBtn = document.getElementById('pauseMusicBtn');
            const donateBtn = document.getElementById('donateBtn');
            const floatingDonate = document.getElementById('floatingDonate');
            // Coach elements
            const floatingCoach = document.getElementById('floatingCoach');
            const coachModal = document.getElementById('coachModal');
            const closeCoach = document.getElementById('closeCoach');
            const coachStart = document.getElementById('coachStart');
            const coachStop = document.getElementById('coachStop');
            const coachExport = document.getElementById('coachExport');
            const coachPart = document.getElementById('coachPart');
            const coachTopic = document.getElementById('coachTopic');
            const coachLog = document.getElementById('coachLog');
            const coachText = document.getElementById('coachText');
            const coachSend = document.getElementById('coachSend');
            const coachStatus = document.getElementById('coachStatus');
            const aiCoachEnable = document.getElementById('aiCoachEnable');
            const aiModelInput = document.getElementById('aiModelInput');
            const aiApiBase = document.getElementById('aiApiBase');
            const aiApiKey = document.getElementById('aiApiKey');
            const aiSaveBtn = document.getElementById('aiSaveBtn');
            const pronEnable = document.getElementById('pronEnable');
            const pronVol = document.getElementById('pronVol');
            const pronPitch = document.getElementById('pronPitch');
            const pronRate = document.getElementById('pronRate');
            const pronPauses = document.getElementById('pronPauses');
            const donateModal = document.getElementById('donateModal');
            const closeDonate = document.getElementById('closeDonate');
            const donateImg = document.getElementById('donateImg');
            const donateFallback = document.getElementById('donateFallback');
            const donateDownload = document.getElementById('donateDownload');
            let donateTriedJpg = false;

            toggleBtn.addEventListener('click', () => {
                running = !running;
                toggleBtn.textContent = running ? 'æš‚åœ' : 'ç»§ç»­';
            });
            burstBtn.addEventListener('click', () => {
                for (let i = 0; i < 6; i++) {
                    const hue = aiEnabled && lastArmIndex != null
                        ? (arms[lastArmIndex].hueMin + Math.random() * (arms[lastArmIndex].hueMax - arms[lastArmIndex].hueMin))
                        : Math.random() * 360;
                    fireworks.push(new Firework(undefined, undefined, hue, gravityValue, particleCountOverride));
                }
            });
            density.addEventListener('input', () => {
                spawnProbability = parseFloat(density.value);
            });
            gravity.addEventListener('input', () => {
                gravityValue = parseFloat(gravity.value);
            });
            trail.addEventListener('change', () => {
                trailEnabled = trail.checked;
            });

            aiMode.addEventListener('change', () => {
                aiEnabled = aiMode.checked;
                if (aiEnabled) {
                    const idx = chooseArm();
                    applyArm(idx);
                } else {
                    aiStatusEl.textContent = '';
                    particleCountOverride = null;
                }
            });

            likeBtn.addEventListener('click', () => {
                if (!aiEnabled || lastArmIndex == null) return;
                stats[lastArmIndex].plays += 1;
                stats[lastArmIndex].reward += 1; // ç‚¹èµè®°ä¸ºæ­£å¥–åŠ±
                applyArm(chooseArm());
            });
            dislikeBtn.addEventListener('click', () => {
                if (!aiEnabled || lastArmIndex == null) return;
                stats[lastArmIndex].plays += 1; // ä»…è®¡ä¸€æ¬¡å°è¯•
                applyArm(chooseArm());
            });

            // éŸ³ä¹åŒæ­¥æ§åˆ¶
            musicSync.addEventListener('change', () => {
                musicEnabled = musicSync.checked;
                if (!musicEnabled) {
                    musicStatusEl.textContent = '';
                }
            });
            function setupAudioForFile(file) {
                if (!file) return;
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioEl) {
                    audioEl.pause();
                    URL.revokeObjectURL(audioEl.src);
                }
                audioEl = new Audio();
                audioEl.src = URL.createObjectURL(file);
                audioEl.loop = true;
                if (sourceNode) sourceNode.disconnect();
                sourceNode = audioCtx.createMediaElementSource(audioEl);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 1024;
                sourceNode.connect(analyser);
                analyser.connect(audioCtx.destination);
                audioEl.play();
                musicEnabled = true; musicSync.checked = true;
                musicStatusEl.textContent = 'éŸ³ä¹å·²åŠ è½½å¹¶å¼€å§‹æ’­æ”¾';
            }
            audioFile.addEventListener('change', () => setupAudioForFile(audioFile.files[0]));
            playMusicBtn.addEventListener('click', async () => {
                try {
                    if (audioCtx) await audioCtx.resume();
                    if (audioEl) await audioEl.play();
                    musicEnabled = true; musicSync.checked = true;
                } catch (e) { musicStatusEl.textContent = 'æ’­æ”¾å¤±è´¥ï¼š' + e.message; }
            });
            pauseMusicBtn.addEventListener('click', async () => {
                try { if (audioEl) audioEl.pause(); } catch (e) {}
            });

            // æ‰“èµå¼¹çª—äº¤äº’
            function loadDonateImage() {
                donateFallback.style.display = 'none';
                donateTriedJpg = false;
                // å…ˆå°è¯• PNGï¼Œå¸¦æ—¶é—´æˆ³é¿å…ç¼“å­˜
                donateImg.src = '';
                donateImg.src = 'donate.png?v=' + Date.now();
                donateDownload.href = 'donate.png';
            }
            donateImg.addEventListener('error', () => {
                if (!donateTriedJpg) {
                    donateTriedJpg = true;
                    donateImg.src = 'donate.jpg?v=' + Date.now();
                    donateDownload.href = 'donate.jpg';
                } else {
                    donateFallback.style.display = 'block';
                }
            });
            donateImg.addEventListener('load', () => { donateFallback.style.display = 'none'; });
            donateBtn.addEventListener('click', () => { donateModal.classList.add('show'); loadDonateImage(); coachModal.classList.remove('show'); floatingCoach.style.display='none'; });
            floatingDonate.addEventListener('click', () => { donateModal.classList.add('show'); loadDonateImage(); coachModal.classList.remove('show'); floatingCoach.style.display='none'; });
            closeDonate.addEventListener('click', () => { donateModal.classList.remove('show'); floatingCoach.style.display='flex'; });
            donateModal.addEventListener('click', (e) => { if (e.target === donateModal) { donateModal.classList.remove('show'); floatingCoach.style.display='flex'; } });

            // ====== é›…æ€é™ªç»ƒé€»è¾‘ ======
            const ieltsBank = {
                1: {
                    hometown: [
                        'Where is your hometown?',
                        'What do you like most about your hometown?',
                        'Has your hometown changed much in recent years?'
                    ],
                    work: [
                        'Are you a student or do you work?',
                        'Why did you choose your major/job?',
                        'What is a typical day like for you?'
                    ],
                    travel: [
                        'Do you like travelling?',
                        'What places have you visited recently?',
                        'Do you prefer travelling alone or with others?'
                    ]
                },
                2: {
                    travel: ['Describe a memorable trip you had. You should say where you went, who you went with, what you did, and explain why it was memorable.'],
                    technology: ['Describe a piece of technology that you find useful. You should say what it is, how you use it, how it helps you, and explain why it is important to you.'],
                    environment: ['Describe a time you helped to protect the environment. You should say what you did, where you were, who was involved, and explain how you felt about it.']
                },
                3: {
                    environment: [
                        'What are the biggest environmental challenges in your country?',
                        'Do you think individuals or governments should take the main responsibility? Why?',
                        'How can technology help to solve environmental problems?'
                    ],
                    technology: [
                        'How has technology changed the way people communicate?',
                        'What are the risks of relying too much on technology?',
                        'Should children be introduced to coding at school?'
                    ]
                }
            };

            let recog; let recognizing = false; let transcript = [];
            let aiCoachOn = false; let aiConf = {base:'', key:'', model:''};
            let micCtx; let micAnalyser; let micStream; let micTimer; let lastVol = 0; let pitchArr = []; let volArr = []; let pauseCount = 0; let startTs = 0; let wordsSpoken = 0;
            function loadAiConf(){
                aiCoachOn = localStorage.getItem('ai.enabled') === '1';
                aiConf.base = localStorage.getItem('ai.base') || '';
                aiConf.key = localStorage.getItem('ai.key') || '';
                aiConf.model = localStorage.getItem('ai.model') || '';
                aiCoachEnable.checked = aiCoachOn;
                aiApiBase.value = aiConf.base || 'https://api.openai.com/v1';
                aiModelInput.value = aiConf.model || 'gpt-4o-mini';
                aiApiKey.value = aiConf.key || '';
            }
            function saveAiConf(){
                aiConf.base = aiApiBase.value.trim();
                aiConf.key = aiApiKey.value.trim();
                aiConf.model = aiModelInput.value.trim();
                localStorage.setItem('ai.base', aiConf.base);
                localStorage.setItem('ai.key', aiConf.key);
                localStorage.setItem('ai.model', aiConf.model);
            }
            loadAiConf();
            aiCoachEnable.addEventListener('change', () => { aiCoachOn = aiCoachEnable.checked; localStorage.setItem('ai.enabled', aiCoachOn ? '1' : '0'); });
            aiSaveBtn.addEventListener('click', () => { saveAiConf(); coachStatus.textContent = 'å·²ä¿å­˜AIé…ç½®'; });
            async function aiFeedback(text){
                if(!aiCoachOn || !aiConf.base || !aiConf.key || !aiConf.model){ giveFeedback(text); setTimeout(askNext, 1200); return; }
                try{
                    coachStatus.textContent = 'AIè¯„ä¼°ä¸­â€¦';
                    const langSel = (document.getElementById('aiLang')||{value:'zh'}).value;
                    const feedbackLang = langSel === 'en' ? 'English' : 'Chinese';
                    const followLang = 'English';
                    const sys = `You are an IELTS speaking coach. Evaluate the user's answer and provide brief ${feedbackLang} feedback with numeric bands (0-9) for Fluency, Lexical Resource, Grammar, Pronunciation. Then suggest one ${followLang} follow-up question. Output as: åé¦ˆ/Feedback: ...\nå»ºè®®/Suggestions: ...\nNext: <question>`;
                    const payload = { model: aiConf.model, messages: [ { role:'system', content: sys }, { role:'user', content: text } ] };
                    const r = await fetch(aiConf.base.replace(/\/$/, '') + '/chat/completions', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + aiConf.key }, body: JSON.stringify(payload) });
                    const j = await r.json();
                    const content = j && j.choices && j.choices[0] && j.choices[0].message && j.choices[0].message.content ? j.choices[0].message.content.trim() : '';
                    if(content){
                        log('Coach', content);
                        transcript.push({role:'coach', text: content});
                        coachSpeak(content);
                        const m = content.match(/Next:\s*(.+)$/m);
                        if(m){ setTimeout(() => { ask(m[1]); }, 1000); } else { setTimeout(askNext, 1200); }
                    } else { giveFeedback(text); setTimeout(askNext, 1200); }
                } catch(e){ giveFeedback(text); setTimeout(askNext, 1200); }
            }
            const hasSTT = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
            function coachSpeak(text) {
                try {
                    const u = new SpeechSynthesisUtterance(text);
                    u.rate = 1; u.pitch = 1;
                    const langSel = (document.getElementById('aiLang')||{value:'zh'}).value;
                    u.lang = langSel === 'en' ? 'en-US' : 'zh-CN';
                    const voices = speechSynthesis.getVoices();
                    const pick = voices.find(v=>v.lang?.toLowerCase().startsWith(u.lang.toLowerCase())) || voices[0];
                    if (pick) u.voice = pick;
                    speechSynthesis.cancel(); speechSynthesis.speak(u);
                } catch (e) {}
            }
            let audioUnlocked = false;
            function unlockAudio() {
                if (audioUnlocked) return; audioUnlocked = true;
                try { if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); } catch(e) {}
                try {
                    const u = new SpeechSynthesisUtterance('.');
                    u.volume = 0; u.lang = 'en-US';
                    speechSynthesis.speak(u);
                } catch(e) {}
                try { speechSynthesis.getVoices(); } catch(e) {}
            }
            function log(role, text) {
                const p = document.createElement('p');
                p.innerHTML = `<strong>${role}:</strong> ${text}`;
                coachLog.appendChild(p);
                coachLog.scrollTop = coachLog.scrollHeight;
            }
            function askNext() {
                const part = coachPart.value; const topic = coachTopic.value;
                const bank = ieltsBank[part];
                let q;
                if (Array.isArray(bank[topic])) {
                    const arr = bank[topic]; q = arr[Math.floor(Math.random()*arr.length)];
                } else { q = bank[topic]; }
                const prompt = typeof q === 'string' ? q : q;
                log('Coach', prompt);
                coachSpeak(prompt);
            }
            function ask(q) { const prompt = typeof q === 'string' ? q : q; log('Coach', prompt); coachSpeak(prompt); }
            async function askAiNext(){
                if(!aiCoachOn || !aiConf.base || !aiConf.key || !aiConf.model){ askNext(); return; }
                try{
                    const part = coachPart.value; const topic = coachTopic.value;
                    const sys = `You are an IELTS speaking examiner. Generate one English question for Part ${part} about ${topic}. Only output the question.`;
                    const payload = { model: aiConf.model, messages: [ { role:'system', content: sys }, { role:'user', content: 'Generate one question.' } ] };
                    const r = await fetch(aiConf.base.replace(/\/$/, '') + '/chat/completions', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + aiConf.key }, body: JSON.stringify(payload) });
                    const j = await r.json();
                    const q = j && j.choices && j.choices[0] && j.choices[0].message && j.choices[0].message.content ? j.choices[0].message.content.trim() : '';
                    if(q){ ask(q); } else { askNext(); }
                } catch(e){ askNext(); }
            }
            function startRecognition() {
                if (!hasSTT) { coachStatus.textContent = 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨æ–‡æœ¬è¾“å…¥ã€‚'; return; }
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                recog = new SR(); recog.lang = 'en-US'; recog.interimResults = false; recog.continuous = false;
                recognizing = true; coachStatus.textContent = 'æ­£åœ¨è†å¬ï¼Œè¯·å¼€å§‹å›ç­”â€¦';
            recog.onresult = (e) => {
                    const text = e.results[0][0].transcript;
                    log('You', text); transcript.push({role:'user', text});
                    reportPron(text);
                    aiFeedback(text);
                };
                recog.onerror = (e) => { coachStatus.textContent = 'è¯†åˆ«é”™è¯¯ï¼š' + e.error; recognizing = false; };
                recog.onend = () => { recognizing = false; coachStatus.textContent = 'å·²åœæ­¢è†å¬'; };
                try { recog.start(); } catch (e) {}
            }
            function stopRecognition() { try { if (recog && recognizing) recog.stop(); } catch (e) {} recognizing = false; }
            function giveFeedback(text) {
                // ç®€æ˜“æ‰“åˆ†ï¼šè¯æ•°ã€å¡«å……è¯ã€è¯­æ³•æŒ‡ç¤ºè¯
                const words = text.trim().split(/\s+/).length;
                const fillers = (text.match(/\b(uh|um|like|you know|kind of)\b/gi)||[]).length;
                const complex = (text.match(/\b(which|that|although|however|moreover|therefore)\b/gi)||[]).length;
                const fluency = Math.max(0, Math.min(9, 5 + (words-20)/20 - fillers));
                const vocab = Math.max(0, Math.min(9, 5 + complex));
                const grammar = 5; // å ä½ï¼Œå¯æ‰©å±•
                const msg = `åé¦ˆï¼šè¯æ•°â‰ˆ${words}ï¼Œå¡«å……è¯${fillers}ï¼Œå¤æ‚è¿æ¥è¯${complex}ã€‚å»ºè®®ï¼šæ”¾æ…¢é€Ÿåº¦ã€ä½¿ç”¨æ›´å¤šè¿æ¥è¯ï¼ˆfor example, moreoverï¼‰ã€‚`;
                log('Coach', msg);
                transcript.push({role:'coach', text: msg});
                coachSpeak('Good job. Try to use more linking words and examples.');
            }

            function exportTxt() {
                const lines = Array.from(coachLog.querySelectorAll('p')).map(p=>p.textContent);
                const blob = new Blob([lines.join('\n')], {type:'text/plain'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ielts_practice.txt'; a.click(); URL.revokeObjectURL(a.href);
            }

            floatingCoach.addEventListener('click', () => { unlockAudio(); coachModal.classList.add('show'); coachLog.innerHTML=''; log('Coach','Welcome! Let\'s practice IELTS Speaking.'); askAiNext(); startRecognition(); startPron(); floatingCoach.style.display='none'; });
            closeCoach.addEventListener('click', () => { coachModal.classList.remove('show'); stopRecognition(); stopPron(); floatingCoach.style.display='flex'; });
            coachStart.addEventListener('click', () => { coachLog.innerHTML=''; askAiNext(); startRecognition(); startPron(); });
            coachStop.addEventListener('click', () => { stopRecognition(); stopPron(); coachStatus.textContent='å·²åœæ­¢é™ªç»ƒ'; });
            coachExport.addEventListener('click', exportTxt);
            coachSend.addEventListener('click', () => { const text = coachText.value.trim(); if(!text) return; coachText.value=''; log('You', text); transcript.push({role:'user', text}); aiFeedback(text); });
        });
    </script>
</body>
</html>
            function startPron(){
                if(!pronEnable.checked) return;
                startTs = Date.now(); wordsSpoken = 0; pauseCount = 0; pitchArr = []; volArr = []; lastVol = 0;
                navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{
                    micStream = s; micCtx = new (window.AudioContext||window.webkitAudioContext)();
                    const src = micCtx.createMediaStreamSource(s); micAnalyser = micCtx.createAnalyser(); micAnalyser.fftSize = 2048; src.connect(micAnalyser);
                    const buf = new Float32Array(micAnalyser.fftSize);
                    micTimer = setInterval(()=>{
                        micAnalyser.getFloatTimeDomainData(buf);
                        let rms = 0; for(let i=0;i<buf.length;i++){ rms += buf[i]*buf[i]; } rms = Math.sqrt(rms/buf.length);
                        const vol = Math.round(rms*1000)/10;
                        volArr.push(vol);
                        pronVol.textContent = vol.toFixed(1);
                        if(vol < 1 && lastVol >= 1) pauseCount += 1;
                        lastVol = vol;
                        const pitch = estimatePitch(buf, micCtx.sampleRate);
                        if(pitch>0){ pitchArr.push(pitch); pronPitch.textContent = Math.round(pitch) + ' Hz'; }
                        pronPauses.textContent = String(pauseCount);
                        const elapsedMin = Math.max(0.001,(Date.now()-startTs)/60000);
                        pronRate.textContent = (wordsSpoken/elapsedMin).toFixed(0) + ' WPM';
                    }, 200);
                }).catch(()=>{});
            }
            function stopPron(){
                if(micTimer){ clearInterval(micTimer); micTimer = null; }
                if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream = null; }
                if(micCtx){ try{ micCtx.close(); }catch(e){} micCtx = null; }
            }
            function estimatePitch(buf, sr){
                let size = buf.length; let maxShift = Math.floor(size/2); let best = 0; let bestCorr = 0;
                for(let shift=40; shift<maxShift; shift++){
                    let corr = 0; for(let i=0;i<maxShift;i++){ corr += buf[i]*buf[i+shift]; }
                    if(corr>bestCorr){ bestCorr=corr; best=shift; }
                }
                const freq = best>0 ? sr/best : 0; if(freq<60||freq>400) return 0; return freq;
            }
            function reportPron(text){
                wordsSpoken += text.trim().split(/\s+/).length;
                const avgVol = volArr.length? (volArr.reduce((a,b)=>a+b,0)/volArr.length):0;
                const avgPitch = pitchArr.length? (pitchArr.reduce((a,b)=>a+b,0)/pitchArr.length):0;
                const pitchVar = pitchArr.length? Math.sqrt(pitchArr.map(p=>Math.pow(p-avgPitch,2)).reduce((a,b)=>a+b,0)/pitchArr.length):0;
                const elapsedMin = Math.max(0.001,(Date.now()-startTs)/60000);
                const wpm = Math.round(wordsSpoken/elapsedMin);
                const msg = `Pronunciation: volumeâ‰ˆ${avgVol.toFixed(1)}, pitchâ‰ˆ${Math.round(avgPitch)}Hz, jitterâ‰ˆ${Math.round(pitchVar)}Hz, pauses=${pauseCount}, rate=${wpm} WPM`;
                log('Coach', msg);
                transcript.push({role:'coach', text: msg});
            }